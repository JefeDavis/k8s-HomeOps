---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: pg-vaultwarden
  annotations:
    cnpg.io/podPatch: |
      [
        {
          "op": "add",
          "path": "/spec/automountServiceAccountToken",
          "value": false
        },
        {
          "op": "add",
          "path": "/spec/volumes/-",
          "value": {
            "name": "serviceaccount-token",
              "projected": {
                "defaultMode": 444,
                "sources": [
                  {
                    "serviceAccountToken": {
                      "expirationSeconds": 3607,
                      "path": "token"
                    }
                  },
                  {
                    "configMap": {
                      "name": "kube-root-ca.crt",
                      "items": [
                        {
                          "key": "ca.crt",
                          "path": "ca.crt"
                        }
                      ]
                    }
                  },
                  {
                    "downwardAPI": {
                      "items": [
                        {
                          "path": "namespace",
                          "fieldRef": {
                            "apiVersion": "v1",
                            "fieldPath": "metadata.namespace"
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            }
          },
          {
            "op": "add",
            "path": "/spec/initContainers/0/volumeMounts/-",
            "value": {
              "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount",
              "name": "serviceaccount-token",
              "readOnly": true
            }
          },
          {
            "op": "add",
            "path": "/spec/containers/0/volumeMounts/-",
            "value": {
              "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount",
              "name": "serviceaccount-token",
              "readOnly": true
            }
          }
        ]
spec:
  inheritedMetadata:
    labels:
      app.kubernetes.io/managed-by: cloudnative-pg
      app.kubernetes.io/part-of: &app vaultwarden
  imagePullSecrets:
    - name: private-registry
  instances: 3
  imageCatalogRef:
    apiGroup: postgresql.cnpg.io
    kind: ClusterImageCatalog
    name: postgresql
    major: 15
  storage:
    size: 8Gi
    storageClass: ${RUNTIME_FLAVOR}-block
  monitoring:
    enablePodMonitor: true
  backup:
    retentionPolicy: 30d
    barmanObjectStore:
      serverName: pg-vaultwarden-v2
      wal:
        compression: bzip2
        maxParallel: 8
      destinationPath: s3://cnpg/
      endpointURL: http://minio.network.svc.cluster.local:9000
      s3Credentials:
        accessKeyId:
          name: cloudnative-pg-secret
          key: AWS_SECRET_ACCESS_KEY_ID
        secretAccessKey:
          name: cloudnative-pg-secret
          key: AWS_SECRET_ACCESS_KEY

  #  # RECOVERY
  bootstrap:
    recovery:
      source: &previous-cluster pg-vaultwarden-v1
      database: vaultwarden
      owner: vaultwarden
  #  ## Note: externalClusters is needed when recovering from an existing cnpg cluster
  externalClusters:
    - name: *previous-cluster
      barmanObjectStore:
        wal:
          compression: bzip2
          maxParallel: 8
        destinationPath: s3://cnpg/
        endpointURL: http://minio.network.svc.cluster.local:9000
        s3Credentials:
          accessKeyId:
            name: cloudnative-pg-secret
            key: AWS_SECRET_ACCESS_KEY_ID
          secretAccessKey:
            name: cloudnative-pg-secret
            key: AWS_SECRET_ACCESS_KEY
